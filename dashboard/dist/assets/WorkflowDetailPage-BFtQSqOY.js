import{j as e,a as N,h as S,r as o,i as u,X as C,q as $,u as V,L as D}from"./index-CwcY_0GV.js";import{t as v}from"./index-Bw4YkTyy.js";import{A as P}from"./arrow-left-Kd_Li62L.js";import{R}from"./rotate-ccw-nPwpX8M5.js";import"./index-XYXLuPD8.js";const b={draft:"bg-muted/15 text-muted border-muted/30",staging:"bg-warning/15 text-warning border-warning/30",production:"bg-success/15 text-success border-success/30",archived:"bg-muted/10 text-muted/60 border-muted/20"};function h({status:s,className:d}){return e.jsx("span",{className:N("inline-flex items-center rounded-full border px-2 py-0.5 text-xs font-medium capitalize",b[s]||b.draft,d),children:s})}function L({versions:s,selectedVersion:d,onSelect:t,onPromote:l}){return e.jsxs("div",{className:"divide-y divide-border",children:[s.map(n=>e.jsxs("div",{onClick:()=>t(n.version),className:`flex items-center justify-between px-4 py-3 cursor-pointer transition-colors ${d===n.version?"bg-accent/10":"hover:bg-border/20"}`,children:[e.jsxs("div",{className:"flex items-center gap-3 min-w-0",children:[e.jsxs("span",{className:"font-mono text-sm font-semibold text-foreground shrink-0",children:["v",n.version]}),e.jsx(h,{status:n.status}),e.jsx("span",{className:"text-xs text-muted truncate",children:n.description||`${n.steps_count} steps`})]}),e.jsxs("div",{className:"flex items-center gap-3 shrink-0",children:[n.created_at&&e.jsx("span",{className:"text-xs text-muted",children:S(n.created_at)}),(n.status==="draft"||n.status==="staging")&&e.jsx("button",{onClick:a=>{a.stopPropagation(),l(n.version)},className:"rounded-md bg-accent/10 px-2 py-1 text-xs font-medium text-accent hover:bg-accent/20 transition-colors",children:n.status==="draft"?"To Staging":"To Production"})]})]},n.id)),s.length===0&&e.jsx("div",{className:"px-4 py-8 text-center text-sm text-muted",children:"No versions found"})]})}function T({open:s,onClose:d,workflowName:t,versionA:l,versionB:n}){const[a,i]=o.useState(null),[p,f]=o.useState(!1);return o.useEffect(()=>{s&&(f(!0),u.get(`/workflows/${t}/versions/diff`,{version_a:String(l),version_b:String(n)}).then(c=>{c.data&&i(c.data)}).finally(()=>f(!1)))},[s,t,l,n]),s?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",onClick:d,children:e.jsxs("div",{className:"relative mx-4 max-h-[85vh] w-full max-w-5xl overflow-hidden rounded-xl border border-border bg-surface shadow-lg",onClick:c=>c.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between border-b border-border px-5 py-3",children:[e.jsxs("h3",{className:"text-sm font-semibold text-foreground",children:["Diff: v",l," vs v",n]}),e.jsx("button",{onClick:d,className:"text-muted hover:text-foreground",children:e.jsx(C,{className:"h-4 w-4"})})]}),p&&e.jsx("div",{className:"p-8 text-center text-sm text-muted",children:"Loading diff..."}),a&&e.jsxs("div",{className:"overflow-auto max-h-[calc(85vh-48px)]",children:[(a.steps_added.length>0||a.steps_removed.length>0||a.steps_changed.length>0)&&e.jsxs("div",{className:"flex gap-4 px-5 py-3 border-b border-border text-xs",children:[a.steps_added.length>0&&e.jsxs("span",{className:"text-success",children:["+",a.steps_added.length," added: ",a.steps_added.join(", ")]}),a.steps_removed.length>0&&e.jsxs("span",{className:"text-error",children:["-",a.steps_removed.length," removed: ",a.steps_removed.join(", ")]}),a.steps_changed.length>0&&e.jsxs("span",{className:"text-warning",children:["~",a.steps_changed.length," changed: ",a.steps_changed.join(", ")]})]}),e.jsxs("div",{className:"grid grid-cols-2 divide-x divide-border",children:[e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"text-xs font-medium text-muted-foreground mb-2",children:["v",l]}),e.jsx("pre",{className:"text-xs font-mono text-foreground whitespace-pre-wrap",children:a.yaml_a})]}),e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"text-xs font-medium text-muted-foreground mb-2",children:["v",n]}),e.jsx("pre",{className:"text-xs font-mono text-foreground whitespace-pre-wrap",children:a.yaml_b})]})]})]})]})}):null}function Y(){const{name:s}=$(),d=V(),[t,l]=o.useState(null),[n,a]=o.useState(!0),[i,p]=o.useState(null),[,f]=o.useState(null),[c,j]=o.useState(null),x=o.useCallback(async()=>{if(s)try{const r=await u.get(`/workflows/${s}/versions`);r.data&&l(r.data)}finally{a(!1)}},[s]);o.useEffect(()=>{x()},[x]);const w=o.useCallback(async r=>{if(p(r),!s)return;const m=await u.get(`/workflows/${s}/versions/${r}`);if(t?.versions.find(g=>g.version===r)){const g=await u.get(`/workflows/${s}/versions/${r}`);g.data&&typeof g.data=="object"&&f(null)}m.data&&f(null)},[s,t]),k=o.useCallback(async r=>{if(!s)return;const m=await u.post(`/workflows/${s}/promote`,{version:r});m.error?v.error(`Promote failed: ${m.error.message}`):(v.success("Version promoted"),x())},[s,x]),_=o.useCallback(async()=>{if(!s)return;const r=await u.post(`/workflows/${s}/rollback`,{});r.error?v.error(`Rollback failed: ${r.error.message}`):(v.success("Rolled back to previous version"),x())},[s,x]);if(n)return e.jsx("div",{className:"flex h-64 items-center justify-center",children:e.jsx(D,{size:"lg"})});if(!t)return e.jsx("div",{className:"py-16 text-center",children:e.jsx("p",{className:"text-muted",children:"Workflow not found"})});const y=t.versions.some(r=>r.status==="archived");return e.jsxs("div",{className:"space-y-4 sm:space-y-6",children:[e.jsxs("button",{onClick:()=>d("/workflows"),className:"flex items-center gap-1 text-sm text-muted hover:text-foreground transition-colors",children:[e.jsx(P,{className:"h-4 w-4"}),"Back to Workflows"]}),e.jsx("div",{className:"rounded-xl border border-border bg-surface p-4 sm:p-5 shadow-sm",children:e.jsxs("div",{className:"flex items-start justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl font-semibold tracking-tight text-foreground",children:t.workflow_name}),e.jsxs("div",{className:"mt-2 flex items-center gap-3 text-sm text-muted",children:[t.production_version!==null&&e.jsxs("span",{className:"flex items-center gap-1.5",children:["Production: ",e.jsx(h,{status:"production"}),e.jsxs("span",{className:"font-mono",children:["v",t.production_version]})]}),t.staging_version!==null&&e.jsxs("span",{className:"flex items-center gap-1.5",children:["Staging: ",e.jsx(h,{status:"staging"}),e.jsxs("span",{className:"font-mono",children:["v",t.staging_version]})]}),t.latest_draft_version!==null&&e.jsxs("span",{className:"flex items-center gap-1.5",children:["Draft: ",e.jsx(h,{status:"draft"}),e.jsxs("span",{className:"font-mono",children:["v",t.latest_draft_version]})]})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:y&&e.jsxs("button",{onClick:_,className:N("flex items-center gap-1.5 rounded-lg border border-warning/30 px-3 py-1.5","text-sm font-medium text-warning","hover:bg-warning/10 transition-colors"),children:[e.jsx(R,{className:"h-4 w-4"}),"Rollback"]})})]})}),i!==null&&t.production_version!==null&&i!==t.production_version&&e.jsxs("button",{onClick:()=>j({a:t.production_version,b:i}),className:"w-full rounded-lg border border-dashed border-accent/40 px-4 py-2 text-xs text-accent hover:bg-accent/5 transition-colors",children:["Compare v",i," with production v",t.production_version]}),e.jsxs("div",{className:"rounded-xl border border-border bg-surface shadow-sm overflow-hidden",children:[e.jsx("div",{className:"border-b border-border px-4 py-3",children:e.jsxs("h2",{className:"text-sm font-semibold text-foreground",children:["Version History (",t.versions.length,")"]})}),e.jsx(L,{versions:t.versions,selectedVersion:i,onSelect:w,onPromote:k})]}),i!==null&&e.jsxs("div",{className:"rounded-xl border border-border bg-surface shadow-sm overflow-hidden",children:[e.jsxs("div",{className:"border-b border-border px-4 py-3 flex items-center justify-between",children:[e.jsxs("h2",{className:"text-sm font-semibold text-foreground",children:["Version ",i," Details"]}),e.jsx("button",{onClick:()=>p(null),className:"text-xs text-muted hover:text-foreground",children:"Close"})]}),e.jsx("div",{className:"p-4",children:(()=>{const r=t.versions.find(m=>m.version===i);return r?e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Status"}),e.jsx("div",{className:"mt-1",children:e.jsx(h,{status:r.status})})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Steps"}),e.jsx("p",{className:"mt-1 font-medium",children:r.steps_count})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Checksum"}),e.jsx("p",{className:"mt-1 font-mono text-xs truncate",children:r.checksum})]})]}),r.description&&e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Description"}),e.jsx("p",{className:"mt-1 text-sm text-foreground",children:r.description})]})]}):null})()})]}),c&&s&&e.jsx(T,{open:!0,onClose:()=>j(null),workflowName:s,versionA:c.a,versionB:c.b})]})}export{Y as default};
